<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Stretch4Sugar</title>
  
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #121212;
      color: #e0e0e0;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #ffffff;
    }
    
    .card {
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      background-color: #1e1e1e;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .camera-card {
      padding: 0;
      overflow: hidden;
    }
    
    .camera-header {
      padding: 15px;
      border-bottom: 1px solid #333;
    }
    
    .camera-feed {
      width: 100%;
      height: 400px;
      background-color: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .camera-feed img {
      max-width: 100%;
      max-height: 100%;
      display: block;
    }
    
    .camera-overlay {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.6);
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .camera-controls {
      display: flex;
      justify-content: space-between;
      padding: 10px 15px;
      background-color: #252525;
    }
    
    .camera-status {
      display: flex;
      align-items: center;
    }
    
    .camera-status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .camera-status-active {
      background-color: #4CAF50;
      box-shadow: 0 0 5px #4CAF50;
    }
    
    .camera-status-inactive {
      background-color: #F44336;
      box-shadow: 0 0 5px #F44336;
    }
    
    .card-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 5px;
      color: #ffffff;
    }
    
    .card-description {
      color: #aaaaaa;
      margin-bottom: 15px;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-connected {
      background-color: #4CAF50;
      box-shadow: 0 0 8px #4CAF50;
    }
    
    .status-disconnected {
      background-color: #F44336;
      box-shadow: 0 0 8px #F44336;
    }
    
    .button {
      background-color: #2e7d32;
      border: none;
      color: white;
      padding: 10px 15px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s, transform 0.1s;
    }
    
    .button:hover:not(:disabled) {
      background-color: #388e3c;
      transform: translateY(-2px);
    }
    
    .button:active:not(:disabled) {
      transform: translateY(1px);
    }
    
    .button:disabled {
      background-color: #333333;
      color: #666666;
      cursor: not-allowed;
    }
    
    .button-outline {
      background-color: #1e1e1e;
      border: 1px solid #2e7d32;
      color: #4CAF50;
    }
    
    .button-outline:hover:not(:disabled) {
      background-color: #2e2e2e;
      border-color: #388e3c;
    }
    
    .button-secondary {
      background-color: #1976D2;
    }
    
    .button-secondary:hover:not(:disabled) {
      background-color: #1E88E5;
    }
    
    .button-small {
      padding: 5px 10px;
      font-size: 14px;
    }
    
    .control-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 300px;
      margin: 0 auto;
    }
    
    .control-button {
      width: 60px;
      height: 60px;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .rotation-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    
    .slider-container {
      margin-bottom: 15px;
    }
    
    .slider-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    input[type="range"] {
      width: 100%;
      background-color: #333;
      height: 8px;
      border-radius: 4px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #4CAF50;
      cursor: pointer;
    }
    
    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #4CAF50;
      cursor: pointer;
    }
    
    .diabetes-controls {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    
    .two-column {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    .no-camera-message {
      color: #aaa;
      text-align: center;
      padding: 20px;
    }
    
    @media (min-width: 600px) {
      .diabetes-controls {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .two-column {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>

<body>
  <h1>Stretch4Sugar</h1>
  
  <!-- Camera Feed Card -->
  <div class="card camera-card">
    <div class="camera-header">
      <div class="card-title">Robot Camera Feed</div>
      <div class="card-description">View from robot's perspective</div>
    </div>
    
    <div class="camera-feed" id="camera-feed">
      <div class="no-camera-message" id="no-camera-message">
        Camera feed not available. Please connect to ROS and start the camera stream.
      </div>
      <img id="camera-image" style="display: none;" alt="Robot camera view">
      <div class="camera-overlay" id="camera-overlay" style="display: none;">
        <span id="camera-fps">0 FPS</span>
      </div>
    </div>
    
    <div class="camera-controls">
      <div class="camera-status">
        <div id="camera-status-indicator" class="camera-status-indicator camera-status-inactive"></div>
        <span id="camera-status-text">Camera Inactive</span>
      </div>
      <div>
        <button id="camera-start-button" class="button button-small" disabled>Start Camera</button>
        <button id="camera-stop-button" class="button button-small button-outline" disabled>Stop Camera</button>
      </div>
    </div>
  </div>
  
  <div class="two-column">
    <div>
      <!-- Connection Status Card -->
      <div class="card">
        <div class="card-title">Connection Status</div>
        <div class="card-description">Connect to the ROS bridge server</div>
        <div>
          <span id="status-indicator" class="status-indicator status-disconnected"></span>
          <span id="status-message">Disconnected</span>
        </div>
        <div style="margin-top: 10px;">
          <button id="connect-button" class="button">Connect</button>
        </div>
      </div>
      
      <!-- Speed Controls Card -->
      <div class="card">
        <div class="card-title">Speed Controls</div>
        <div class="card-description">Adjust linear and angular speeds</div>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>Linear Speed:</span>
            <span id="linear-speed-value">0.20 m/s</span>
          </div>
          <input type="range" id="linear-speed" min="0.05" max="0.5" step="0.05" value="0.2">
        </div>
        
        <div class="slider-container">
          <div class="slider-label">
            <span>Angular Speed:</span>
            <span id="angular-speed-value">0.50 rad/s</span>
          </div>
          <input type="range" id="angular-speed" min="0.1" max="1.0" step="0.1" value="0.5">
        </div>
      </div>
    </div>
    
    <div>
      <!-- Movement Controls Card -->
      <div class="card">
        <div class="card-title">Movement Controls</div>
        <div class="card-description">Control the robot's movement</div>
        
        <div class="control-grid">
          <!-- Top row -->
          <div></div>
          <button id="forward-button" class="button button-outline control-button" disabled>↑</button>
          <div></div>
          
          <!-- Middle row -->
          <button id="left-button" class="button button-outline control-button" disabled>←</button>
          <button id="stop-button" class="button button-outline control-button" disabled>■</button>
          <button id="right-button" class="button button-outline control-button" disabled>→</button>
          
          <!-- Bottom row -->
          <div></div>
          <button id="backward-button" class="button button-outline control-button" disabled>↓</button>
          <div></div>
        </div>
        
        <div class="rotation-controls">
          <button id="rotate-left-button" class="button button-outline control-button" disabled>↺</button>
          <button id="rotate-right-button" class="button button-outline control-button" disabled>↻</button>
        </div>
      </div>
      
      <!-- Diabetes Support Controls Card -->
      <div class="card">
        <div class="card-title">Diabetes Support Controls</div>
        <div class="card-description">Quick actions for diabetes support</div>
        
        <div class="diabetes-controls">
          <button id="glucose-button" class="button button-secondary" disabled>Deliver Emergency Glucose</button>
          <button id="insulin-button" class="button button-secondary" disabled>Bring Insulin Kit</button>
          <button id="supplies-button" class="button button-secondary" disabled>Bring Testing Supplies</button>
        </div>
      </div>
    </div>
  </div>
  
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>

    <script type="text/javascript">
    /* ---------- 1. GLOBALS ---------- */
    let ros, cmdVel;                     // <<< UPDATED
    let connected   = false;
    let linearSpeed = 0.20;
    let angularSpeed = 0.50;

    /* ---------- 2. DOM SHORTCUTS ---------- */
    const $ = id => document.getElementById(id);   // <<< UPDATED
    const connectBtn = $('connect-button');
    const statusLed  = $('status-indicator');
    const statusTxt  = $('status-message');

    /* movement buttons */
    const btn = {
    forward : $('forward-button'),
    back    : $('backward-button'),
    left    : $('left-button'),
    right   : $('right-button'),
    rotL    : $('rotate-left-button'),
    rotR    : $('rotate-right-button'),
    stop    : $('stop-button')
    };

    /* sliders */
    const linSlider = $('linear-speed');
    const angSlider = $('angular-speed');
    const linVal    = $('linear-speed-value');
    const angVal    = $('angular-speed-value');

    /* ---------- 3. ROS CONNECTION ---------- */
    function connectROS () {
    ros = new ROSLIB.Ros({ url : 'ws://localhost:9090' });            // change host if needed

    ros.on('connection', () => {                                      // <<< UPDATED
        connected = true;
        statusLed.classList.replace('status-disconnected','status-connected');
        statusTxt.textContent = 'Connected';
        connectBtn.disabled = true;
        enableMotionBtns(true);
        initCmdVelTopic();                                              // <<< UPDATED
    });

    ros.on('error', err => {
        console.error(err);
        showDisconnect('Error – see console');
    });

    ros.on('close', () => showDisconnect('Disconnected'));
    }

    function showDisconnect(msg){
    connected = false;
    statusLed.classList.replace('status-connected','status-disconnected');
    statusTxt.textContent = msg;
    connectBtn.disabled = false;
    enableMotionBtns(false);
    }

    /* ---------- 4. /cmd_vel TOPIC ---------- */
    function initCmdVelTopic(){                                         // <<< ADDED
    cmdVel = new ROSLIB.Topic({
        ros,
        name : '/cmd_vel',
        messageType : 'geometry_msgs/Twist'
    });
    }

    /* helper that scales by sliders and publishes */
    function sendVel(lx = 0, az = 0){                                   // <<< UPDATED
    if(!connected) return;
    const msg = new ROSLIB.Message({
        linear  : { x: lx * linearSpeed, y: 0, z: 0 },
        angular : { x: 0, y: 0, z: az * angularSpeed }
    });
    cmdVel.publish(msg);
    console.log('publish', msg);                                      // quick feedback
    }

    /* ---------- 5. BUTTON WIRING ---------- */
    function hold(btn, onStart){                                        // <<< ADDED
    btn.addEventListener('mousedown', onStart);
    btn.addEventListener('touchstart', e => { e.preventDefault(); onStart(); });
    ['mouseup','mouseleave','touchend'].forEach(ev =>
        btn.addEventListener(ev, () => sendVel(0,0)));
    }

    hold(btn.forward, () => sendVel( +1 , 0));
    hold(btn.back   , () => sendVel( -1 , 0));
    hold(btn.left   , () => sendVel(  0 , +1));  // strafe left  (Stretch = positive angular?) adjust if needed
    hold(btn.right  , () => sendVel(  0 , -1));
    hold(btn.rotL   , () => sendVel( 0 , +1));
    hold(btn.rotR   , () => sendVel( 0 , -1));
    btn.stop.addEventListener('click', () => sendVel(0,0));

    /* enable/disable set */
    function enableMotionBtns(state){                                   // <<< ADDED
    Object.values(btn).forEach(b => b.disabled = !state);
    }

    /* ---------- 6. SLIDER HANDLERS ---------- */
    linSlider.oninput = e => {
    linearSpeed = parseFloat(e.target.value);
    linVal.textContent = linearSpeed.toFixed(2)+' m/s';
    };
    angSlider.oninput = e => {
    angularSpeed = parseFloat(e.target.value);
    angVal.textContent = angularSpeed.toFixed(2)+' rad/s';
    };

    /* ---------- 7. KEYBOARD SHORTCUTS ---------- */
    document.addEventListener('keydown', e=>{
    if(!connected) return;
    switch(e.key){
        case 'ArrowUp':   sendVel(+1,0); break;
        case 'ArrowDown': sendVel(-1,0); break;
        case 'ArrowLeft': sendVel(0,+1); break;
        case 'ArrowRight':sendVel(0,-1); break;
        case ' ':         sendVel(0,0);  break;
    }
    });
    document.addEventListener('keyup', ()=> sendVel(0,0));

    /* ---------- 8. BOOT ---------- */
    connectBtn.addEventListener('click', connectROS);
    enableMotionBtns(false);                                            // <<< UPDATED
    </script>

</body>
</html>
